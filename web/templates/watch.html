{% extends "base.html" %}
{% block title %}{{ video.title }}{% endblock %}

{% block content %}
{% if schedule_info and schedule_info.allowed %}
<div class="schedule-banner schedule-open">
    <span>Available until {{ schedule_info.end }}</span>
</div>
{% endif %}

{% if time_info %}
<div class="time-budget {% if time_info.remaining_min < 15 %}time-budget-low{% endif %}">
    <span>{{ cat_label }}: {{ time_info.remaining_min | int }} min remaining</span>
    <span class="time-budget-detail">{{ time_info.used_min | int }} / {{ time_info.limit_min }} min used</span>
</div>
{% endif %}

<div class="watch-container{% if is_short %} watch-container-short{% endif %}">
    <div class="video-player">
        <div class="video-wrapper">
            <div id="ytplayer"></div>
            <button id="fs-toggle" class="fs-toggle" onclick="toggleFullscreen()" aria-label="Fullscreen"></button>
        </div>
    </div>

    <div class="watch-info">
        <h2 class="watch-title">{{ video.title }}</h2>
        <p class="watch-channel">{{ video.channel_name }}</p>
        {% if time_info %}
        <p class="time-remaining" id="time-remaining">
            {{ cat_label }} time left: <span id="time-counter">{{ time_info.remaining_min | int }} min</span>
        </p>
        {% endif %}
        <a href="/" class="back-link">Back to Library</a>
    </div>
</div>

{% if time_info %}
<div class="time-warning" id="time-warning" style="display:none;">
    Less than 5 minutes remaining
</div>
<div class="time-critical" id="time-critical" style="display:none;">
    Less than 1 minute remaining!
</div>
<div class="time-overlay" id="time-overlay" style="display:none;">
    <div class="time-overlay-content">
        <div class="timesup-icon">&#x23F0;</div>
        <h2>Time's Up!</h2>
        <p>Redirecting to home...</p>
    </div>
</div>
{% endif %}

<script>
var tag = document.createElement('script');
tag.src = "/api/yt-iframe-api.js";
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

var player;
var isPlaying = false;
var playSeconds = 0;
var heartbeatInterval = null;
// NOTE: remainingSeconds is client-side and can be manipulated via DevTools.
// The server heartbeat response is the authority and corrects this value every 15s.
var remainingSeconds = {{ time_info.remaining_sec if time_info else -1 }};
var hasTimeLimit = {{ 'true' if time_info else 'false' }};
var videoId = {{ video.video_id | tojson }};
var countdownInterval = null;

function toggleFullscreen() {
    var wrapper = document.querySelector('.video-wrapper');
    if (!wrapper) return;
    var fsEl = document.fullscreenElement || document.webkitFullscreenElement;
    if (fsEl) {
        (document.exitFullscreen || document.webkitExitFullscreen).call(document);
    } else {
        var rfs = wrapper.requestFullscreen || wrapper.webkitRequestFullscreen;
        if (rfs) rfs.call(wrapper).catch(function() {});
    }
}

document.addEventListener('fullscreenchange', updateFsButton);
document.addEventListener('webkitfullscreenchange', updateFsButton);
function updateFsButton() {
    var btn = document.getElementById('fs-toggle');
    if (btn) btn.classList.toggle('fs-exit', !!(document.fullscreenElement || document.webkitFullscreenElement));
}

// Replace placeholder div with sandboxed iframe before YT API loads
(function() {
    var placeholder = document.getElementById('ytplayer');
    var iframe = document.createElement('iframe');
    iframe.id = 'ytplayer';
    iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin');
    iframe.setAttribute('allowfullscreen', '');
    iframe.src = 'https://www.youtube-nocookie.com/embed/' + videoId
        + '?enablejsapi=1&autoplay=0&rel=0&modestbranding=1'
        + '&origin=' + encodeURIComponent(window.location.origin);
    placeholder.parentNode.replaceChild(iframe, placeholder);
})();

function onYouTubeIframeAPIReady() {
    player = new YT.Player('ytplayer', {
        events: {
            'onStateChange': onPlayerStateChange
        }
    });
}

var endCheckInterval = null;

function onPlayerStateChange(event) {
    if (event.data === YT.PlayerState.PLAYING) {
        isPlaying = true;
        hidePauseOverlay();
        if (!heartbeatInterval) {
            heartbeatInterval = setInterval(sendHeartbeat, 15000);
        }
        if (hasTimeLimit && !countdownInterval) {
            countdownInterval = setInterval(tickCountdown, 1000);
        }
        if (!endCheckInterval) {
            endCheckInterval = setInterval(checkNearEnd, 1000);
        }
    } else if (event.data === YT.PlayerState.ENDED) {
        isPlaying = false;
        hidePauseOverlay();
        if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
        if (endCheckInterval) { clearInterval(endCheckInterval); endCheckInterval = null; }
        if (playSeconds > 0) { sendHeartbeat(); }
        showEndOverlay();
    } else if (event.data === YT.PlayerState.PAUSED) {
        isPlaying = false;
        showPauseOverlay();
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
        if (playSeconds > 0) {
            sendHeartbeat();
        }
    } else {
        isPlaying = false;
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
        if (endCheckInterval) {
            clearInterval(endCheckInterval);
            endCheckInterval = null;
        }
        if (playSeconds > 0) {
            sendHeartbeat();
        }
    }
}

function showPauseOverlay() {
    var existing = document.getElementById('pause-overlay');
    if (existing) { existing.style.display = 'flex'; return; }
    var overlay = document.createElement('div');
    overlay.id = 'pause-overlay';
    overlay.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(26,26,46,0.85);display:flex;align-items:center;justify-content:center;z-index:10;border-radius:8px;cursor:pointer;';
    var btn = document.createElement('div');
    btn.style.cssText = 'width:72px;height:72px;background:rgba(231,76,111,0.9);border-radius:50%;display:flex;align-items:center;justify-content:center;';
    var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', '32');
    svg.setAttribute('height', '32');
    svg.setAttribute('viewBox', '0 0 24 24');
    var tri = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
    tri.setAttribute('points', '8,5 19,12 8,19');
    tri.setAttribute('fill', 'white');
    svg.appendChild(tri);
    btn.appendChild(svg);
    overlay.appendChild(btn);
    overlay.onclick = function() {
        overlay.style.display = 'none';
        if (player && player.playVideo) player.playVideo();
    };
    var wrapper = document.querySelector('.video-wrapper');
    if (wrapper) wrapper.appendChild(overlay);
}

function hidePauseOverlay() {
    var el = document.getElementById('pause-overlay');
    if (el) el.style.display = 'none';
}

function checkNearEnd() {
    if (!player || !player.getDuration || !player.getCurrentTime) return;
    var duration = player.getDuration();
    var current = player.getCurrentTime();
    if (duration > 0 && current > 0 && (duration - current) <= 15) {
        clearInterval(endCheckInterval);
        endCheckInterval = null;
        showEndOverlay();
    }
}

function showEndOverlay() {
    var existing = document.getElementById('end-overlay');
    if (existing) { existing.style.display = 'flex'; return; }
    var overlay = document.createElement('div');
    overlay.id = 'end-overlay';
    overlay.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;background:#1a1a2e;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;border-radius:8px;gap:16px;';
    var msg = document.createElement('p');
    msg.textContent = 'Video finished';
    msg.style.cssText = 'color:#ccc;font-size:1.2em;margin:0;';
    var btn = document.createElement('div');
    btn.style.cssText = 'width:72px;height:72px;background:rgba(231,76,111,0.9);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;';
    var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', '32');
    svg.setAttribute('height', '32');
    svg.setAttribute('viewBox', '0 0 24 24');
    svg.setAttribute('fill', 'white');
    // Replay/rewind icon: circular arrow
    var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', 'M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z');
    svg.appendChild(path);
    btn.appendChild(svg);
    btn.onclick = function() {
        overlay.style.display = 'none';
        if (player && player.seekTo) { player.seekTo(0, true); player.playVideo(); }
    };
    var link = document.createElement('a');
    link.href = '/';
    link.textContent = 'Back to Library';
    link.style.cssText = 'color:#888;font-size:1em;text-decoration:none;';
    overlay.appendChild(msg);
    overlay.appendChild(btn);
    overlay.appendChild(link);
    var wrapper = document.querySelector('.video-wrapper');
    if (wrapper) { wrapper.style.position = 'relative'; wrapper.appendChild(overlay); }
}

function tickCountdown() {
    if (!isPlaying || !hasTimeLimit) return;
    remainingSeconds--;
    playSeconds++;
    updateTimeDisplay();

    if (remainingSeconds <= 0) {
        timesUp();
    }
}

function updateTimeDisplay() {
    var counterEl = document.getElementById('time-counter');
    var warningEl = document.getElementById('time-warning');
    var criticalEl = document.getElementById('time-critical');
    var remainingEl = document.getElementById('time-remaining');
    if (!counterEl || !remainingEl) return;

    if (remainingSeconds > 60) {
        var min = Math.max(0, Math.ceil(remainingSeconds / 60));
        counterEl.textContent = min + ' min';
    } else {
        counterEl.textContent = Math.max(0, remainingSeconds) + ' sec';
        counterEl.className = 'time-low';
    }

    if (warningEl && remainingSeconds <= 300 && remainingSeconds > 60) {
        warningEl.style.display = 'block';
        if (criticalEl) criticalEl.style.display = 'none';
    } else if (criticalEl && remainingSeconds <= 60 && remainingSeconds > 0) {
        criticalEl.style.display = 'block';
        if (warningEl) warningEl.style.display = 'none';
    }
}

function timesUp() {
    isPlaying = false;
    clearInterval(heartbeatInterval);
    clearInterval(countdownInterval);
    if (player && player.pauseVideo) player.pauseVideo();
    var overlay = document.getElementById('time-overlay');
    if (overlay) overlay.style.display = 'flex';
    if (playSeconds > 0) {
        doHeartbeat(playSeconds);
        playSeconds = 0;
    }
    setTimeout(function() { window.location.href = '/'; }, 3000);
}

function sendHeartbeat() {
    if (playSeconds <= 0) return;
    var secs = playSeconds;
    playSeconds = 0;
    doHeartbeat(secs);
}

function doHeartbeat(secs) {
    fetch('/api/watch-heartbeat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({video_id: videoId, seconds: secs})
    }).then(function(r) {
        if (r.status === 403) {
            timesUp();
            return null;
        }
        return r.json();
    }).then(function(data) {
        if (!data) return;
        if (hasTimeLimit && typeof data.remaining === 'number' && data.remaining >= 0) {
            remainingSeconds = data.remaining;
            updateTimeDisplay();
            if (remainingSeconds <= 0) timesUp();
        }
    }).catch(function() {});
}
</script>
{% endblock %}
