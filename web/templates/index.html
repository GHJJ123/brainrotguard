{% extends "base.html" %}

{% block search_attrs %}autofocus{% endblock %}

{% block content %}
{% if schedule_info and not schedule_info.allowed %}
<div class="schedule-banner schedule-closed">
    <span>Videos available at {{ schedule_info.unlock_time }}</span>
    <span class="schedule-detail">{{ schedule_info.start }} &ndash; {{ schedule_info.end }}</span>
</div>
{% elif schedule_info and schedule_info.allowed %}
<div class="schedule-banner schedule-open">
    <span>Available until {{ schedule_info.end }}</span>
</div>
{% endif %}

{% if time_info %}
<a href="/activity" class="time-budget {% if time_info.remaining_min < 15 %}time-budget-low{% endif %}">
    {% if time_info.exceeded %}
    <span class="time-low">No time remaining today</span>
    {% else %}
    <span>{{ time_info.remaining_min | int }} min remaining today</span>
    <span class="time-budget-detail">{{ time_info.used_min | int }} / {{ time_info.limit_min }} min used</span>
    {% endif %}
</a>
{% endif %}

{% if hero_highlights %}
{# Hero carousel: random video from each allowlisted channel #}
<div class="hero-carousel" id="hero-carousel">
    {% for vid in hero_highlights[:10] %}
    <a href="/watch/{{ vid.video_id }}" class="hero-slide{% if loop.first %} active{% endif %}">
        <img src="https://i.ytimg.com/vi/{{ vid.video_id }}/maxresdefault.jpg" alt="{{ vid.title }}"{% if not loop.first %} loading="lazy"{% endif %}>
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <span class="hero-channel">{{ vid.channel_name }}</span>
            <h2 class="hero-title">{{ vid.title }}</h2>
            <span class="hero-duration">{{ format_duration(vid.duration) }}</span>
            <div class="hero-play-hint">
                <span class="play-icon"></span>
                Watch Now
            </div>
        </div>
    </a>
    {% endfor %}
    <div class="hero-dots" id="hero-dots"></div>
</div>
{% endif %}

{% if channel_videos %}
{# Channel pills: filter catalog by allowlisted channel #}
<div class="channel-pills">
    <button class="channel-pill active" data-channel="__all__">All</button>
    {% for ch_name in channel_videos %}
    <button class="channel-pill" data-channel="{{ ch_name }}">{{ ch_name }}</button>
    {% endfor %}
</div>
{% endif %}

{% if cat_info %}
<div class="cat-cards-row">
    <button class="cat-card-all active" data-category="__all__">All</button>
    {% for cat_name, info in cat_info.categories.items() %}
    {% set cat_label = "Educational" if cat_name == "edu" else "Entertainment" %}
    <button class="cat-card cat-card-{{ cat_name }}{% if info.exceeded %} cat-card-exceeded{% endif %}" data-category="{{ cat_name }}">
        <span class="cat-card-left">
            <span class="cat-card-name">{{ cat_label }}</span>
            {% if info.exceeded %}
            <span class="cat-card-sub">time's up</span>
            {% elif info.limit_min > 0 %}
            <span class="cat-card-sub">of {{ info.limit_min }}m</span>
            {% else %}
            <span class="cat-card-sub">Unlimited</span>
            {% endif %}
        </span>
        {% if info.limit_min > 0 %}
        <span class="cat-card-right">
            <span class="cat-card-time">{{ info.remaining_min | int }}<span class="cat-card-m">m</span></span>
            <span class="cat-card-bar"><span class="cat-card-bar-fill" style="width:{{ ((info.remaining_min / info.limit_min) * 100) | int }}%"></span></span>
        </span>
        {% endif %}
    </button>
    {% endfor %}
</div>
{% endif %}

{% if catalog %}
<section class="videos-section">
    <h2 class="section-title">Your Videos</h2>
    <div class="video-grid" id="catalog-grid">
        {% for video in catalog %}
        <a href="/watch/{{ video.video_id }}" class="video-card" data-channel="{{ video.channel_name }}" data-category="{{ video.category or 'fun' }}">
            <div class="thumbnail-wrap">
                <img src="{{ video.thumbnail_url }}" alt="{{ video.title }}" class="video-thumbnail" loading="lazy">
                {% if video.duration %}
                <span class="duration-badge">{{ format_duration(video.duration) }}</span>
                {% endif %}
                {% if video.category %}
                <span class="category-badge category-{{ video.category }}">{{ "Edu" if video.category == "edu" else "Fun" }}</span>
                {% endif %}
            </div>
            <div class="video-info">
                <h3 class="video-title">{{ video.title }}</h3>
                <p class="video-channel">{{ video.channel_name }}</p>
            </div>
        </a>
        {% endfor %}
    </div>
    <div class="show-more-wrap" id="show-more-wrap"{% if not has_more %} style="display:none"{% endif %}>
        <button class="btn-primary show-more-btn" id="show-more-btn">Show More</button>
    </div>
</section>
{% else %}
<section class="videos-section">
    <h2 class="section-title">Your Videos</h2>
    <div class="empty-state">
        <div class="empty-icon">&#x1f50d;</div>
        <p>No videos yet</p>
        <p class="empty-hint">Search for something to watch!</p>
    </div>
</section>
{% endif %}

<script>
(function() {
    // Hero carousel: auto-advance with crossfade + Ken Burns
    var heroCarousel = document.getElementById('hero-carousel');
    if (heroCarousel) {
        var slides = heroCarousel.querySelectorAll('.hero-slide');
        var dotsContainer = document.getElementById('hero-dots');
        var current = 0;
        var heroInterval = 6000;
        var heroTimer;

        // Build dots
        slides.forEach(function(_, i) {
            var dot = document.createElement('button');
            dot.className = 'hero-dot' + (i === 0 ? ' active' : '');
            dot.addEventListener('click', function() { heroGoTo(i); heroResetTimer(); });
            dotsContainer.appendChild(dot);
        });

        function heroGoTo(index) {
            slides[current].classList.remove('active');
            slides[current].querySelector('img').style.transform = 'scale(1)';
            dotsContainer.children[current].classList.remove('active');
            current = index;
            void slides[current].querySelector('img').offsetWidth;
            slides[current].classList.add('active');
            void dotsContainer.children[current].offsetWidth;
            dotsContainer.children[current].classList.add('active');
        }

        function heroResetTimer() {
            clearInterval(heroTimer);
            heroTimer = setInterval(function() {
                heroGoTo((current + 1) % slides.length);
            }, heroInterval);
        }

        heroCarousel.addEventListener('mouseenter', function() { clearInterval(heroTimer); });
        heroCarousel.addEventListener('mouseleave', function() { heroResetTimer(); });

        // Touch swipe support
        var touchStartX = 0;
        var touchStartY = 0;
        var swiping = false;
        heroCarousel.addEventListener('touchstart', function(e) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            swiping = false;
            clearInterval(heroTimer);
        }, {passive: true});
        heroCarousel.addEventListener('touchmove', function(e) {
            if (!touchStartX) return;
            var dx = e.touches[0].clientX - touchStartX;
            var dy = e.touches[0].clientY - touchStartY;
            // Only count as swipe if horizontal movement dominates
            if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 20) {
                swiping = true;
                e.preventDefault();
            }
        }, {passive: false});
        heroCarousel.addEventListener('touchend', function(e) {
            if (!swiping) { heroResetTimer(); return; }
            var dx = e.changedTouches[0].clientX - touchStartX;
            if (dx < -40) {
                heroGoTo((current + 1) % slides.length);
            } else if (dx > 40) {
                heroGoTo((current - 1 + slides.length) % slides.length);
            }
            touchStartX = 0;
            swiping = false;
            heroResetTimer();
        });

        heroResetTimer();
    }

    // XSS-safe HTML escaping
    function escapeHtml(str) {
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
    }

    // Client-side duration formatter (mirrors server-side format_duration)
    function formatDuration(seconds) {
        if (!seconds) return '?';
        seconds = Math.floor(seconds);
        var h = Math.floor(seconds / 3600);
        var m = Math.floor((seconds % 3600) / 60);
        var s = seconds % 60;
        if (h) return h + ':' + String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
        return m + ':' + String(s).padStart(2, '0');
    }

    // Shared: build a video card element
    function buildCard(v) {
        var a = document.createElement('a');
        a.href = '/watch/' + encodeURIComponent(v.video_id);
        a.className = 'video-card';
        a.dataset.channel = v.channel_name || '';
        a.dataset.category = v.category || 'fun';
        var dur = v.duration ? '<span class="duration-badge">' + escapeHtml(formatDuration(v.duration)) + '</span>' : '';
        var catBadge = v.category ? '<span class="category-badge category-' + escapeHtml(v.category) + '">' + (v.category === 'edu' ? 'Edu' : 'Fun') + '</span>' : '';
        // eslint-disable-next-line no-unsanitized/property -- values are escaped via escapeHtml()
        a.innerHTML =
            '<div class="thumbnail-wrap">' +
                '<img src="' + escapeHtml(v.thumbnail_url || '') + '" alt="' + escapeHtml(v.title || '') + '" class="video-thumbnail" loading="lazy">' +
                dur +
                catBadge +
            '</div>' +
            '<div class="video-info">' +
                '<h3 class="video-title">' + escapeHtml(v.title || '') + '</h3>' +
                '<p class="video-channel">' + escapeHtml(v.channel_name || '') + '</p>' +
            '</div>';
        return a;
    }

    var catalogGrid = document.getElementById('catalog-grid');
    var showMoreBtn = document.getElementById('show-more-btn');
    var showMoreWrap = document.getElementById('show-more-wrap');
    var PAGE_SIZE = 24;
    var catalogOffset = {{ catalog | length }};
    var activeFilter = '';
    var activeCatFilter = '';
    var filterOffset = 0;
    var filterHasMore = false;
    // Stash initial HTML so we can restore on "All"
    var initialGridHTML = catalogGrid ? catalogGrid.innerHTML : '';
    var initialOffset = catalogOffset;
    var initialHasMore = {{ 'true' if has_more else 'false' }};

    function fetchCatalog(channel, offset, limit, replace) {
        var url = '/api/catalog?offset=' + offset + '&limit=' + limit;
        if (channel) url += '&channel=' + encodeURIComponent(channel);
        if (activeCatFilter) url += '&category=' + encodeURIComponent(activeCatFilter);
        return fetch(url).then(function(r) { return r.json(); }).then(function(data) {
            if (replace) catalogGrid.innerHTML = '';
            if (data.videos.length === 0 && replace) {
                catalogGrid.innerHTML = '<p style="color:#666;text-align:center;padding:20px;">No videos found</p>';
            } else {
                data.videos.forEach(function(v) { catalogGrid.appendChild(buildCard(v)); });
            }
            return data;
        });
    }

    // Channel pills: fetch filtered results from API
    document.querySelectorAll('.channel-pill').forEach(function(pill) {
        pill.addEventListener('click', function() {
            var channel = this.dataset.channel;
            var isAll = channel === '__all__';
            var isActive = this.classList.contains('active');

            document.querySelectorAll('.channel-pill').forEach(function(p) {
                p.classList.remove('active');
            });

            if (isActive && !isAll) {
                document.querySelector('.channel-pill[data-channel="__all__"]').classList.add('active');
                restoreAll();
                return;
            }

            this.classList.add('active');

            if (isAll) {
                restoreAll();
                return;
            }

            activeFilter = channel;
            activeCatFilter = '';
            document.querySelectorAll('.cat-card, .cat-card-all').forEach(function(p) { p.classList.remove('active'); });
            var allCatPill = document.querySelector('.cat-card-all[data-category="__all__"]');
            if (allCatPill) allCatPill.classList.add('active');
            catalogGrid.innerHTML = '<p style="color:#666;text-align:center;padding:20px;">Loading...</p>';

            fetchCatalog(channel, 0, PAGE_SIZE, true)
                .then(function(data) {
                    filterOffset = data.videos.length;
                    filterHasMore = data.has_more;
                    showMoreWrap.style.display = filterHasMore ? '' : 'none';
                    if (showMoreBtn) {
                        showMoreBtn.disabled = false;
                        showMoreBtn.textContent = 'Show More';
                    }
                })
                .catch(function() {
                    catalogGrid.innerHTML = '<p style="color:#888;text-align:center;padding:20px;">Failed to load</p>';
                    showMoreWrap.style.display = 'none';
                });
        });
    });

    // Category cards: filter by edu/fun
    document.querySelectorAll('.cat-card, .cat-card-all').forEach(function(card) {
        card.addEventListener('click', function() {
            var category = this.dataset.category;
            var isAll = category === '__all__';
            var isActive = this.classList.contains('active');

            document.querySelectorAll('.cat-card, .cat-card-all').forEach(function(p) {
                p.classList.remove('active');
            });

            if (isActive && !isAll) {
                document.querySelector('.cat-card-all[data-category="__all__"]').classList.add('active');
                activeCatFilter = '';
                restoreAll();
                return;
            }

            this.classList.add('active');

            if (isAll) {
                activeCatFilter = '';
                restoreAll();
                return;
            }

            activeCatFilter = category;
            activeFilter = '';  // clear channel filter
            // Also reset channel pills
            document.querySelectorAll('.channel-pill').forEach(function(p) { p.classList.remove('active'); });
            var allChPill = document.querySelector('.channel-pill[data-channel="__all__"]');
            if (allChPill) allChPill.classList.add('active');

            catalogGrid.innerHTML = '<p style="color:#666;text-align:center;padding:20px;">Loading...</p>';
            fetchCatalog('', 0, PAGE_SIZE, true)
                .then(function(data) {
                    filterOffset = data.videos.length;
                    filterHasMore = data.has_more;
                    showMoreWrap.style.display = filterHasMore ? '' : 'none';
                    if (showMoreBtn) {
                        showMoreBtn.disabled = false;
                        showMoreBtn.textContent = 'Show More';
                    }
                })
                .catch(function() {
                    catalogGrid.innerHTML = '<p style="color:#888;text-align:center;padding:20px;">Failed to load</p>';
                    showMoreWrap.style.display = 'none';
                });
        });
    });

    function restoreAll() {
        activeFilter = '';
        activeCatFilter = '';
        catalogGrid.innerHTML = initialGridHTML;
        catalogOffset = initialOffset;
        if (showMoreWrap) showMoreWrap.style.display = initialHasMore ? '' : 'none';
        if (showMoreBtn) {
            showMoreBtn.disabled = false;
            showMoreBtn.textContent = 'Show More';
        }
    }

    // Show More: works for both All and filtered views
    if (showMoreBtn) {
        showMoreBtn.addEventListener('click', function() {
            showMoreBtn.disabled = true;
            showMoreBtn.textContent = 'Loading...';
            var ch = activeFilter || '';
            var off = (activeFilter || activeCatFilter) ? filterOffset : catalogOffset;

            fetchCatalog(ch, off, PAGE_SIZE, false)
                .then(function(data) {
                    if (activeFilter || activeCatFilter) {
                        filterOffset += data.videos.length;
                        filterHasMore = data.has_more;
                    } else {
                        catalogOffset += data.videos.length;
                        initialGridHTML = catalogGrid.innerHTML;
                        initialOffset = catalogOffset;
                        initialHasMore = data.has_more;
                    }
                    if (!data.has_more) {
                        showMoreWrap.style.display = 'none';
                    } else {
                        showMoreBtn.disabled = false;
                        showMoreBtn.textContent = 'Show More';
                    }
                })
                .catch(function() {
                    showMoreBtn.disabled = false;
                    showMoreBtn.textContent = 'Show More';
                });
        });
    }
})();
</script>
{% endblock %}
